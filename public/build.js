(()=>{"use strict";var e={890:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.drawTiles=void 0;const i=n(575),s=n(564),r=n(384);t.drawTiles=function(){const e=(0,s.createCanvas)(i.CANVAS_WIDTH,i.CANVAS_HEIGHT),t=e.getContext("2d");for(let e=0;e<i.CANVAS_WIDTH;e+=s.TILE_HEIGHT)for(let n=0;n<i.CANVAS_WIDTH;n+=s.TILE_WIDTH)t.drawImage((0,r.sample)(s.sprites.tile_grass.frames),n,e);return e}},575:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Game=t.CANVAS_HEIGHT=t.CANVAS_WIDTH=void 0;const i=n(59),s=n(890),r=n(931),o=n(564),a=n(865);t.CANVAS_WIDTH=1024,t.CANVAS_HEIGHT=768;const c=(0,i.randomPosition)((0,i.createEntity)());t.Game=class{constructor(e,n=document.body){if(this.lastDraw=0,this.trotFrame=0,this.lastInfoUpdate=0,this.fps=0,this.player=c,this.entities=[],this.serverStat="<no server stat>",this.canvas=document.createElement("canvas"),this.canvas.width=t.CANVAS_WIDTH,this.canvas.height=t.CANVAS_HEIGHT,this.player.name=e,this.reconnect(),n.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.context.textAlign="center",!this.context)throw alert("Failed creating canvas context, refresh the page"),new Error("Failed creating context");addEventListener("keydown",(e=>this.handleKeydown(e)),!1),addEventListener("keyup",(e=>this.handleKeyup(e))),requestAnimationFrame((e=>this.update(e)))}get width(){return this.canvas.width}get height(){return this.canvas.height}get infoText(){return`fps ${Math.floor(this.fps)} | connected ${!!this.connection?.connected} | (${this.player.x}, ${this.player.y}, ${this.player.right}) | ${this.serverStat}`}drawMap(){this.mapBuffer||(this.mapBuffer=(0,s.drawTiles)()),this.context.drawImage(this.mapBuffer,0,0)}drawBanner(e){this.context.save(),this.context.fillStyle="#333",this.context.fillRect(0,t.CANVAS_HEIGHT/2-40,t.CANVAS_WIDTH,80),this.context.fillStyle="#fff",this.context.fillText(e,t.CANVAS_WIDTH/2,t.CANVAS_HEIGHT/2),this.context.restore()}handleKeydown(e){let t=this.player.vx,n=this.player.vy;switch(e.key){case"a":case"ArrowLeft":t=-1;break;case"d":case"ArrowRight":t=1;break;case"w":case"ArrowUp":n=-1;break;case"s":case"ArrowDown":n=1}t===this.player.vx&&n===this.player.vy||(this.player.vx=t,this.player.vy=n,this.connection?.sendMove(t,n)),"F12"!==e.key&&e.preventDefault()}handleKeyup({key:e}){let t=this.player.vx,n=this.player.vy;switch(e){case"a":case"d":case"ArrowLeft":case"ArrowRight":t=0;break;case"w":case"s":case"ArrowUp":case"ArrowDown":n=0}t===this.player.vx&&n===this.player.vy||(this.player.vx=t,this.player.vy=n,this.connection?.sendMove(t,n))}drawEntity(e){this.context.save();let t=1;e.right&&(this.context.scale(-1,1),t=-1),(0,i.isMoving)(e)?(this.context.translate(-o.sprites.faith_trot.centerX,-o.sprites.faith_trot.centerY),this.context.drawImage(o.sprites.faith_trot.frames[this.trotFrame],t*e.x,e.y)):(this.context.translate(-o.sprites.faith_stand.centerX,-o.sprites.faith_stand.centerY),this.context.drawImage(o.sprites.faith_stand.frames[0],t*e.x,e.y)),this.context.restore()}reconnect(){(0,r.requestJoin)(this,this.player.name).then((e=>{this.connection=e,this.entities.push(this.player),e.sendJoin(this.player.x,this.player.y,this.player.right)}))}draw(){this.context.clearRect(0,0,t.CANVAS_WIDTH,t.CANVAS_HEIGHT),this.drawMap();for(let e of this.entities)this.drawEntity(e);this.connection?.connected||this.drawBanner("Connecting...")}update(e){(0,i.moveUpdate)(e,this.entities),e-this.lastDraw>=1e3/60&&(this.fps=1e3/(e-this.lastDraw),this.trotFrame=Math.floor(e/40)%o.trotFrames,this.lastDraw=e,this.draw()),e-this.lastInfoUpdate>=2e3&&(this.lastInfoUpdate=e,(0,a.updateInfoText)(this.infoText)),requestAnimationFrame((e=>this.update(e)))}}},931:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.requestJoin=t.ServerAction=void 0;const i=n(879),s=n(59);class r{constructor(e,t,n){this.ws=e,this.game=t,this.id=n,e.onmessage=e=>this.handleMsg(e),e.onclose=()=>{t.entities.length=0,setTimeout((()=>t.reconnect()),3e3)},this.game.player.id=n}async handleMsg({data:e}){if(!e.size)return;const t=new Uint8Array(await e.arrayBuffer()),n=t[0];switch(n){case 3:this.game.serverStat=await e.slice(1).text();break;case 0:{const e=(0,i.decodeId)(t[1],t[2]);if(e===this.id)break;const{x:n,y:r,right:o}=(0,i.decodePosition)(t[3],t[4],t[5]);this.game.entities.push((0,s.createFromJoin)(e,n,r,o));break}case 4:{let e=1;for(;e<t.length;){const n=(0,i.decodeId)(t[e++],t[e++]);if(n===this.id){e+=3;continue}const{x:r,y:o,right:a}=(0,i.decodePosition)(t[e++],t[e++],t[e++]);this.game.entities.push((0,s.createFromJoin)(n,r,o,a))}break}case 1:const r=(0,i.decodeId)(t[1],t[2]),o=this.game.entities.findIndex((e=>e.id===r));-1!==o&&this.game.entities.splice(o);case 2:let a=1;for(;a<t.length;){const{id:e,x:n,y:s,right:r,vx:o,vy:c}=(0,i.decodeMovement)(t[a++],t[a++],t[a++],t[a++],t[a++],t[a++]),d=this.game.entities.find((t=>t.id===e));d?(d.right=r,d.x=n,d.y=s,e!==this.id&&(d.vx=o,d.vy=c)):console.warn("Cannot find entity "+e)}break;default:console.error("Unknown action"+n)}}get connected(){return this.ws.readyState===this.ws.OPEN}sendJoin(e,t,n){this.ws.send(new Uint8Array([0,...(0,i.encodeId)(this.id),...(0,i.encodePosition)(e,t,n)]))}sendMove(e,t){this.ws.send(new Uint8Array([2,(0,i.encodeVelocity)(e,t)]))}disconnect(){this.ws.close()}}t.ServerAction=r,t.requestJoin=async function(e,t){const n=await fetch("/api-join",{method:"POST",headers:{"Content-Type":"text/plain"},body:t}),[i,s]=(await n.text()).split(","),o=new WebSocket(`ws://${location.hostname}:${i}/`),a=new r(o,e,parseInt(s,10));return new Promise((e=>{o.onopen=()=>e(a)}))}},564:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.initSprites=t.TILE_HEIGHT=t.TILE_WIDTH=t.createCanvas=t.trotFrames=t.sprites=void 0,t.sprites={},t.trotFrames=0;const n=e=>new Promise(((t,n)=>{const i=document.createElement("img"),s=setTimeout((()=>n("request timed out")),5e3);i.onload=()=>{t(i),clearTimeout(s)},i.src=e}));function i(e,t){const n=document.createElement("canvas");return n.width=e,n.height=t,n}function*s(e,t,n){const s=e.width,r=e.height;for(let o=0;o<=r-n;o+=n)for(let r=0;r<=s-t;r+=t){const s=i(t,n);s.getContext("2d").drawImage(e,r,o,t,n,0,0,t,n),yield s}}function r(e,n,i,r,o,a){t.sprites[e]={width:i,height:r,centerX:o,centerY:a,frames:[...s(n,i,r)]}}t.createCanvas=i,t.TILE_WIDTH=32,t.TILE_HEIGHT=24,t.initSprites=async function(){const[e,i,s]=await Promise.all([n("/assets/grass.png"),n("/assets/trot.png"),n("/assets/stand.png")]);r("tile_grass",e,32,24,0,0),r("faith_trot",i,43,56,22,53),r("faith_stand",s,43,54,22,51),t.trotFrames=t.sprites.faith_trot.frames.length}},865:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.updateInfoText=t.createInfoText=t.createTestButton=t.createDiv=void 0,t.createDiv=function(e=document.body){return e.appendChild(document.createElement("div"))},t.createTestButton=function(e=document.body){const t=document.createElement("button");return t.innerText="Add 100 clients",e.appendChild(t),t.onclick=()=>{fetch("/api-perf",{method:"GET"})},t};let n=document.createElement("div");t.createInfoText=function(e=document.body){e.appendChild(n)},t.updateInfoText=function(e){n.innerText=e}},384:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sample=void 0,t.sample=function(e){if(!e.length)throw new Error("No items in array");const t=e.length;return e[Math.floor(Math.random()*t)]}},879:(e,t)=>{function n(e){return[255&e,e>>8&255]}function i(e,t){return e|t<<8}function s(e,t,n){return[255&e,e>>8&15|(15&t)<<4,t>>4&127|(n?1:0)<<7]}function r(e,t,n){return{x:e|(15&t)<<8,y:t>>4|(127&n)<<4,right:!!(128&n)}}function o(e,t){return e+1|t+1<<2}function a(e){return{vx:(3&e)-1,vy:(e>>2&3)-1}}Object.defineProperty(t,"__esModule",{value:!0}),t.decodeMovement=t.encodeMovement=t.decodeVelocity=t.encodeVelocity=t.decodePosition=t.encodePosition=t.decodeId=t.encodeId=void 0,t.encodeId=n,t.decodeId=i,t.encodePosition=s,t.decodePosition=r,t.encodeVelocity=o,t.decodeVelocity=a,t.encodeMovement=function(e,t,i,r,a,c){return[...n(e),...s(t,i,r),o(a,c)]},t.decodeMovement=function(e,t,n,s,o,c){return{id:i(e,t),...r(n,s,o),...a(c)}}},59:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.moveUpdate=t.isMoving=t.randomPosition=t.createFromJoin=t.createEntity=void 0;const i=n(351);function s(e){return 0!==e.vx||0!==e.vy}t.createEntity=function(){return{id:0,x:0,y:0,vx:0,vy:0,right:!1,name:"Faith Donk"}},t.createFromJoin=function(e,t,n,i){return{id:e,x:t,y:n,right:i,vx:0,vy:0,name:"Faith Donk"}},t.randomPosition=function(e){return e.x=Math.floor(1024*Math.random()),e.y=Math.floor(768*Math.random()),e.right=Math.random()<.5,e},t.isMoving=s;let r=0;t.moveUpdate=function(e,t){e-r>=20&&(r=e,t.forEach((e=>{e&&("entity"in e?s(e.entity)&&(e.entity.x=(0,i.clamp)(3*e.entity.vx+e.entity.x,0,1024),e.entity.y=(0,i.clamp)(3*e.entity.vy+e.entity.y,0,768),0!==e.entity.vx&&(e.entity.right=e.entity.vx>0)):s(e)&&(e.x=(0,i.clamp)(2*e.vx+e.x,0,1024),e.y=(0,i.clamp)(2*e.vy+e.y,0,768),0!==e.vx&&(e.right=e.vx>0)))})))}},351:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.delay=t.clamp=void 0,t.clamp=function(e,t,n){return Math.min(Math.max(e,t),n)},t.delay=async function(e){return new Promise((t=>setTimeout(t,e)))}}},t={};function n(i){var s=t[i];if(void 0!==s)return s.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}(()=>{const e=n(575),t=n(564),i=n(865),s="Faith Donk",r=prompt("Enter your nickname to join",s)??s;document.title=r,(0,t.initSprites)().then((()=>{window.game=new e.Game(r);const t=(0,i.createDiv)();(0,i.createInfoText)(t),(0,i.createTestButton)(t);const n=console.error;console.error=(...e)=>{n(...e),(0,i.createDiv)(t).innerHTML="[error]"+e.join(" ")}}))})()})();