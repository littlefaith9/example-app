(()=>{"use strict";var t={890:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.drawTiles=void 0;const i=n(575),o=n(564),r=n(384);e.drawTiles=function(){const t=(0,o.createCanvas)(i.CANVAS_WIDTH,i.CANVAS_HEIGHT),e=t.getContext("2d");for(let t=0;t<i.CANVAS_WIDTH;t+=o.TILE_HEIGHT)for(let n=0;n<i.CANVAS_WIDTH;n+=o.TILE_WIDTH)e.drawImage((0,r.sample)(o.sprites.tile_grass.frames),n,t);return t}},575:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Game=e.CANVAS_HEIGHT=e.CANVAS_WIDTH=void 0;const i=n(59),o=n(890),r=n(931),s=n(564),a=n(865);e.CANVAS_WIDTH=1024,e.CANVAS_HEIGHT=768;const c=(0,i.randomPosition)((0,i.createEntity)());e.Game=class{constructor(t,n=document.body){if(this.lastDraw=0,this.trotFrame=0,this.lastInfoUpdate=0,this.fps=0,this.player=c,this.entities=[c],this.serverStat="",this.canvas=document.createElement("canvas"),this.canvas.width=e.CANVAS_WIDTH,this.canvas.height=e.CANVAS_HEIGHT,(0,r.requestJoin)(this,t).then((t=>{this.connection=t,t.sendJoin(this.player.x,this.player.y,this.player.right)})),n.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.context.textAlign="center",!this.context)throw alert("Failed creating canvas context, refresh the page"),new Error("Failed creating context");addEventListener("keydown",(t=>this.handleKeydown(t))),addEventListener("keyup",(t=>this.handleKeyup(t))),requestAnimationFrame((t=>this.update(t)))}get width(){return this.canvas.width}get height(){return this.canvas.height}get infoText(){return`fps ${Math.floor(this.fps)} | connected ${!!this.connection?.connected} | (${this.player.x}, ${this.player.y}, ${this.player.right}) | ${this.serverStat}`}drawMap(){this.mapBuffer||(this.mapBuffer=(0,o.drawTiles)()),this.context.drawImage(this.mapBuffer,0,0)}drawBanner(t){this.context.save(),this.context.fillStyle="#333",this.context.fillRect(0,e.CANVAS_HEIGHT/2-40,e.CANVAS_WIDTH,80),this.context.fillStyle="#fff",this.context.fillText(t,e.CANVAS_WIDTH/2,e.CANVAS_HEIGHT/2),this.context.restore()}handleKeydown({key:t}){switch(t){case"ArrowLeft":this.player.vx=-1;break;case"ArrowRight":this.player.vx=1;break;case"ArrowUp":this.player.vy=-1;break;case"ArrowDown":this.player.vy=1}this.connection?.sendMove()}handleKeyup({key:t}){switch(t){case"ArrowLeft":case"ArrowRight":this.player.vx=0;break;case"ArrowUp":case"ArrowDown":this.player.vy=0}this.connection?.sendMove()}drawEntity(t){this.context.save();let e=1;t.right&&(this.context.scale(-1,1),e=-1),(0,i.isMoving)(t)?(this.context.translate(-s.sprites.faith_trot.centerX,-s.sprites.faith_trot.centerY),this.context.drawImage(s.sprites.faith_trot.frames[this.trotFrame],e*t.x,t.y)):(this.context.translate(-s.sprites.faith_stand.centerX,-s.sprites.faith_stand.centerY),this.context.drawImage(s.sprites.faith_stand.frames[0],e*t.x,t.y)),this.context.restore()}draw(){this.context.clearRect(0,0,e.CANVAS_WIDTH,e.CANVAS_HEIGHT),this.drawMap();for(let t of this.entities)this.drawEntity(t)}update(t){(0,i.moveUpdate)(t,this.entities),t-this.lastDraw>=1e3/60&&(this.fps=1e3/(t-this.lastDraw),this.trotFrame=Math.floor(t/40)%s.sprites.faith_trot.frames.length,this.lastDraw=t,this.draw(),this.connection?.connected||this.drawBanner("Connecting...")),t-this.lastInfoUpdate>=2e3&&(this.lastInfoUpdate=t,(0,a.updateInfoText)(this.infoText)),requestAnimationFrame((t=>this.update(t)))}}},931:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.requestJoin=e.ServerAction=void 0;const i=n(879),o=n(59);class r{constructor(t,e,n){this.ws=t,this.game=e,this.id=n,t.onmessage=t=>this.handleMsg(t),this.game.player.id=n}async handleMsg({data:t}){const e=new Uint8Array(await t.arrayBuffer()),n=e[0];switch(n){case 3:this.game.serverStat=await t.slice(1).text();break;case 0:{const t=(0,i.decodeId)(e[1],e[2]);if(t===this.id)break;const{x:n,y:r,right:s}=(0,i.decodePosition)(e[3],e[4],e[5]);this.game.entities.push((0,o.createFromJoin)(t,n,r,s));break}case 4:{let t=1;for(;t<e.length;){const n=(0,i.decodeId)(e[t++],e[t++]),{x:r,y:s,right:a}=(0,i.decodePosition)(e[t++],e[t++],e[t++]);n!==this.id&&this.game.entities.push((0,o.createFromJoin)(n,r,s,a))}break}case 1:const r=(0,i.decodeId)(e[1],e[2]),s=this.game.entities.findIndex((t=>t.id===r));-1!==s&&this.game.entities.splice(s);case 2:let a=1;for(;a<e.length;){const{id:t,x:n,y:o,right:r,vx:s,vy:c}=(0,i.decodeMovement)(e[a++],e[a++],e[a++],e[a++],e[a++],e[a++]),d=this.game.entities.find((e=>e.id===t));d?(d.x=n,d.y=o,d.right=r,t!==this.id&&(d.vx=s,d.vy=c)):console.warn("Cannot find entity "+t)}break;default:console.error("Unknown action: "+n)}}get connected(){return this.ws.readyState===this.ws.OPEN}sendJoin(t,e,n){this.ws.send(new Uint8Array([0,...(0,i.encodeId)(this.id),...(0,i.encodePosition)(t,e,n)]))}sendMove(){const{vx:t,vy:e}=this.game.player;this.ws.send(new Uint8Array([2,(0,i.encodeVelocity)(t,e)]))}}e.ServerAction=r,e.requestJoin=async function(t,e){const n=await fetch("/api-join",{method:"POST",headers:{"Content-Type":"text/plain"},body:e}),[i,o]=(await n.text()).split(","),s=new WebSocket(`ws://${location.hostname}:${i}/`),a=new r(s,t,parseInt(o,10));return new Promise((t=>{s.onopen=()=>t(a)}))}},564:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.initSprites=e.TILE_HEIGHT=e.TILE_WIDTH=e.createCanvas=e.sprites=void 0,e.sprites={};const n=t=>new Promise(((e,n)=>{const i=document.createElement("img"),o=setTimeout((()=>n("request timed out")),5e3);i.onload=()=>{e(i),clearTimeout(o)},i.src=t}));function i(t,e){const n=document.createElement("canvas");return n.width=t,n.height=e,n}function*o(t,e,n){const o=t.width,r=t.height;for(let s=0;s<=r-n;s+=n)for(let r=0;r<=o-e;r+=e){const o=i(e,n);o.getContext("2d").drawImage(t,r,s,e,n,0,0,e,n),yield o}}function r(t,n,i,r,s,a){e.sprites[t]={width:i,height:r,centerX:s,centerY:a,frames:[...o(n,i,r)]}}e.createCanvas=i,e.TILE_WIDTH=32,e.TILE_HEIGHT=24,e.initSprites=async function(){const[t,e,i]=await Promise.all([n("/assets/grass.png"),n("/assets/trot.png"),n("/assets/stand.png")]);r("tile_grass",t,32,24,0,0),r("faith_trot",e,43,56,22,53),r("faith_stand",i,43,54,22,51)}},865:(t,e,n)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.updateInfoText=e.createInfoText=e.createTestButton=e.createDiv=void 0;const i=n(59),o=n(931);e.createDiv=function(t=document.body){return t.appendChild(document.createElement("div"))},e.createTestButton=function(t=document.body){const e=document.createElement("button");return e.innerText="Add 100 clients",t.appendChild(e),e.onclick=()=>{for(let t=0;t<100;t++){const t={connection:void 0,player:(0,i.randomPosition)((0,i.createEntity)()),entities:[],clients:0};(0,o.requestJoin)(t,"test").then((e=>{t.connection=e,e.sendJoin(t.player.x,t.player.y,t.player.right)}))}},e};let r=document.createElement("div");e.createInfoText=function(t=document.body){t.appendChild(r)},e.updateInfoText=function(t){r.innerText=t}},384:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.sample=void 0,e.sample=function(t){if(!t.length)throw new Error("No items in array");const e=t.length;return t[Math.floor(Math.random()*e)]}},879:(t,e)=>{function n(t){return[255&t,t>>8&255]}function i(t,e){return t|e<<8}function o(t,e,n){return[255&t,t>>8&15|(15&e)<<4,e>>4&127|(n?1:0)<<7]}function r(t,e,n){return{x:t|(15&e)<<8,y:e>>4|(127&n)<<4,right:!!(128&n)}}function s(t,e){return t+1|e+1<<2}function a(t){return{vx:(3&t)-1,vy:(t>>2&3)-1}}Object.defineProperty(e,"__esModule",{value:!0}),e.decodeMovement=e.encodeMovement=e.decodeVelocity=e.encodeVelocity=e.decodePosition=e.encodePosition=e.decodeId=e.encodeId=void 0,e.encodeId=n,e.decodeId=i,e.encodePosition=o,e.decodePosition=r,e.encodeVelocity=s,e.decodeVelocity=a,e.encodeMovement=function(t,e,i,r,a,c){return[...n(t),...o(e,i,r),s(a,c)]},e.decodeMovement=function(t,e,n,o,s,c){return{id:i(t,e),...r(n,o,s),...a(c)}}},59:(t,e)=>{function n(t){return 0!==t.vx||0!==t.vy}Object.defineProperty(e,"__esModule",{value:!0}),e.moveUpdate=e.isMoving=e.randomPosition=e.createFromJoin=e.createEntity=void 0,e.createEntity=function(){return{id:0,x:0,y:0,vx:0,vy:0,right:!1,name:"Faith Donk"}},e.createFromJoin=function(t,e,n,i){return{id:t,x:e,y:n,right:i,vx:0,vy:0,name:"Faith Donk"}},e.randomPosition=function(t){return t.x=Math.floor(1024*Math.random()),t.y=Math.floor(768*Math.random()),t.right=Math.random()<.5,t},e.isMoving=n;let i=0;e.moveUpdate=function(t,e){t-i>=20&&(i=t,e.forEach((t=>{t&&("entity"in t?n(t.entity)&&(t.entity.x+=2*t.entity.vx,t.entity.y+=2*t.entity.vy,0!==t.entity.vx&&(t.entity.right=t.entity.vx>0)):n(t)&&(t.x+=2*t.vx,t.y+=2*t.vy,0!==t.vx&&(t.right=t.vx>0)))})))}}},e={};function n(i){var o=e[i];if(void 0!==o)return o.exports;var r=e[i]={exports:{}};return t[i](r,r.exports,n),r.exports}(()=>{const t=n(575),e=n(564),i=n(865),o="Faith Donk",r=prompt("Enter your nickname to join",o)??o;document.title=r,(0,e.initSprites)().then((()=>{window.game=new t.Game(r);const e=(0,i.createDiv)();(0,i.createInfoText)(e),(0,i.createTestButton)(e)}))})()})();